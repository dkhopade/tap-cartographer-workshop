apiVersion: learningcenter.tanzu.vmware.com/v1beta1
kind: TrainingPortal
metadata:
  name: scc-workshops
spec:
  portal:
    title: Workshops for Supply Chain Choreographer
    ingress:
      hostname: scc-workshops
    registration:
      type: anonymous
    updates:
      workshop: true
    sessions:
      maximum: 40
    reserved: 1
  workshops:
  - name: scc-workshop
    expires: 200m
    orphaned: 200m
---
apiVersion: learningcenter.tanzu.vmware.com/v1beta1
kind: Workshop
metadata:
  name: scc-workshop
spec:
  title: Supply Chain Choreographer
  description: A workshop that demonstrates all the capabilities Supply Chain Choreographer provides.
  vendor: tanzu.vmware.com
  difficulty: beginner
  duration: 200m
  url: https://github.com/tsalm-pivotal/tap-cartographer-workshop
  content:
    image: harbor.svcs.az-tkglab.sprok8s.com/tap-workshop/cartographer-workshop:latest
    files: github.com/devops/tap-cartographer-workshop/workshop?ref=main
  session:
    namespaces:
      budget: custom
    applications:
      terminal:
        enabled: true
        layout: split
      console:
        enabled: true
        vendor: octant
      editor:
        enabled: true
    env:
    - name: TAP_INGRESS
      value: omdeepak.net
    - name: TAP_CNRS_SUBDOMAIN
      value: cnr.omdeepak.net
    - name: CONTAINER_REGISTRY_HOSTNAME
      value: harbor.svcs.az-tkglab.sprok8s.com
    - name: CONTAINER_REGISTRY_USERNAME
      value: admin
    - name: CONTAINER_REGISTRY_PASSWORD
      value: VMware1!
    - name: CONTAINER_REGISTRY_REPOSITORY
      value: tap-wkld
    - name: GITOPS_REPOSITORY
      value: http://gitea.omdeepak.net/$(session_namespace)/$(session_namespace).git
    - name: GITOPS_REPOSITORY_USERNAME
      value: devops
    - name: GITOPS_REPOSITORY_PASSWORD
      value: VMWare1!
    objects:
    - apiVersion: v1
      kind: LimitRange
      metadata:
        name: resource-limits
      spec:
        limits:
        - type: PersistentVolumeClaim
          max:
            storage: 10Gi
    - apiVersion: v1
      kind: Secret
      metadata:
        name: tanzu-net-credentials
      type: kubernetes.io/dockerconfigjson
      data:
        .dockerconfigjson: eyJhdXRocyI6eyJyZWdpc3RyeS50YW56dS52bXdhcmUuY29tIjp7ImF1dGgiOiJaM1YwYldGdVoyRkFkbTEzWVhKbExtTnZiVHBIYldGdVFIWnRkelJ5TXc9PSIsInBhc3N3b3JkIjoiR21hbkB2bXc0cjMiLCJ1c2VybmFtZSI6Imd1dG1hbmdhQHZtd2FyZS5jb20ifX19
    - apiVersion: rbac.authorization.k8s.io/v1
      kind: Role
      metadata:
        name: $(session_namespace)-default
      rules:
      - apiGroups:
        - source.toolkit.fluxcd.io
        resources:
        - gitrepositories
        verbs:
        - '*'
      - apiGroups:
        - source.apps.tanzu.vmware.com
        resources:
        - imagerepositories
        verbs:
        - '*'
      - apiGroups:
        - carto.run
        resources:
        - deliverables
        - runnables
        verbs:
        - '*'
      - apiGroups:
        - kpack.io
        resources:
        - images
        verbs:
        - '*'
      - apiGroups:
        - conventions.apps.tanzu.vmware.com
        resources:
        - podintents
        verbs:
        - '*'
      - apiGroups:
        - ""
        resources:
        - configmaps
        verbs:
        - '*'
      - apiGroups:
        - ""
        resources:
        - pods
        verbs:
        - list
      - apiGroups:
        - tekton.dev
        resources:
        - taskruns
        - pipelineruns
        verbs:
        - '*'
      - apiGroups:
        - tekton.dev
        resources:
        - pipelines
        verbs:
        - list
      - apiGroups:
        - kappctrl.k14s.io
        resources:
        - apps
        verbs:
        - '*'
      - apiGroups:
        - serving.knative.dev
        resources:
        - services
        verbs:
        - '*'
      - apiGroups:
        - servicebinding.io
        resources:
        - servicebindings
        verbs:
        - '*'
      - apiGroups:
        - services.apps.tanzu.vmware.com
        resources:
        - resourceclaims
        verbs:
        - '*'
      - apiGroups:
        - scanning.apps.tanzu.vmware.com
        resources:
        - imagescans
        - sourcescans
        verbs:
        - '*'
      - apiGroups:
        - timosalm.de
        resources:
        - githubrepositories
        verbs:
        - '*'
    - apiVersion: rbac.authorization.k8s.io/v1
      kind: RoleBinding
      metadata:
        name: $(session_namespace)-default
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: Role
        name: $(session_namespace)-default
      subjects:
      - kind: ServiceAccount
        name: default
        namespace: $(session_namespace)
    - apiVersion: rbac.authorization.k8s.io/v1
      kind: RoleBinding
      metadata:
        name: $(session_namespace)-session-crb
        namespace: $(session_namespace)
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: ClusterRole
        name: cluster-admin
      subjects:
      - kind: ServiceAccount
        namespace: $(workshop_namespace)
        name: $(service_account)
    - apiVersion: rbac.authorization.k8s.io/v1
      kind: RoleBinding
      metadata:
        name: $(session_namespace)-default-crb
        namespace: $(session_namespace)
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: ClusterRole
        name: cluster-admin
      subjects:
      - kind: ServiceAccount
        namespace: $(session_namespace)
        name: default
    - apiVersion: packaging.carvel.dev/v1alpha1
      kind: PackageInstall
      metadata:
        name: $(session_namespace)-grype
        namespace: tap-install
      spec:
        serviceAccountName: tap-install-sa
        packageRef:
          refName: grype.scanning.apps.tanzu.vmware.com
          versionSelection:
            constraints: '>=0.0.0'
            prereleases:
              identifiers:
              - beta
              - build
        values:
        - secretRef:
            name: $(session_namespace)-grype-values
    - apiVersion: v1
      kind: Secret
      metadata:
        name: $(session_namespace)-grype-values
        namespace: tap-install
      stringData:
        values.yaml: |
          ---
          namespace: $(session_namespace)
          targetImagePullSecret: registry-credentials
    - apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRole
      metadata:
        name: $(session_namespace)-cluster-resources-reader
      rules:
      - apiGroups:
        - conventions.apps.tanzu.vmware.com
        resources:
        - clusterpodconventions
        verbs:
        - get
        - watch
        - list
    - apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      metadata:
        name: $(session_namespace)-cluster-resources
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: ClusterRole
        name: $(session_namespace)-cluster-resources-reader
      subjects:
      - kind: Group
        name: system:serviceaccounts:$(workshop_namespace)
        apiGroup: rbac.authorization.k8s.io
    - apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRole
      metadata:
        name: $(session_namespace)-cluster-supplychain
      rules:
      - apiGroups:
        - carto.run
        resources:
        - clusterconfigtemplates
        - clusterdeliveries
        - clusterdeploymenttemplates
        - clusterimagetemplates
        - clusterruntemplates
        - clustersourcetemplates
        - clustersupplychains
        - clustertemplates
        verbs:
        - '*'
      - apiGroups:
        - apiextensions.k8s.io
        resources:
        - customresourcedefinitions
        verbs:
        - get
        - watch
        - list
    - apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      metadata:
        name: $(session_namespace)-cluster-supplychain
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: ClusterRole
        name: $(session_namespace)-cluster-supplychain
      subjects:
      - kind: Group
        name: system:serviceaccounts:$(workshop_namespace)
        apiGroup: rbac.authorization.k8s.io
